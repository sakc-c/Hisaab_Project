{% extends 'hisaab/base.html' %}

{% block content %}
    <style>
        .tighter-form .row {
            margin-left: -5px;
            margin-right: -5px;
        }
        .tighter-form .col-3, .tighter-form .col-7, .tighter-form .col-4, .tighter-form .col-8 {
            padding-left: 5px;
            padding-right: 5px;
        }
        .form-label {
            text-align: right;
            padding-right: 0;
        }
    </style>

    <h2 class="mb-5">Create Bill</h2>

    <form method="post" id="createBillForm" class="tighter-form">
        {% csrf_token %}

        <!-- Customer Name -->
        <div class="mb-4 row">
            <div class="col-3">
                <label for="customer_name" class="form-label">Customer Name:</label>
            </div>
            <div class="col-7">
                <input type="text" class="form-control" id="customer_name" name="customer_name" required>
            </div>
        </div>

        <!-- Product, Quantity, Price, and + button -->
        <div id="productFields">
            <div class="row mb-4 product-row">
                <div class="col-4">
                    <label for="product_1" class="form-label">Product:</label>
                    <select class="form-select" name="product_1" required>
                        {% for product in products %}
                            <option value="{{ product.id }}" data-price="{{ product.unitPrice }}">{{ product.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-3">
                    <label for="quantity_1" class="form-label">Quantity:</label>
                    <input type="number" class="form-control" name="quantity_1" min="1" value="1" required>
                </div>
                <div class="col-3">
                    <label for="price_1" class="form-label">Unit Price:</label>
                    <input type="text" class="form-control" name="price_1" id="price_1" readonly>
                </div>
                <div class="col-2 d-flex align-items-center justify-content-center">
                    <button type="button" class="btn btn-sm btn-success add-product">+</button>
                </div>
            </div>
        </div>

        <!-- Discount -->
        <div class="row mb-4">
            <div class="col-3">
                <label for="discount" class="form-label">Discount:</label>
            </div>
            <div class="col-7">
                <select class="form-select" name="discount" id="discount" required>
                    <option value="5">5%</option>
                    <option value="10">10%</option>
                    <option value="15">15%</option>
                </select>
            </div>
        </div>

        <!-- Total -->
        <div class="row mb-4">
            <div class="col-3">
                <label for="total" class="form-label">Total:</label>
            </div>
            <div class="col-7">
                <input type="text" class="form-control" id="total" readonly>
            </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end gap-3">
            <button type="button" class="btn btn-success" id="generateTotal">Generate Total</button>
            <button type="submit" class="btn btn-primary" id="createBillBtn">Create Bill</button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize prices for existing products
            document.querySelectorAll('select[name^="product_"]').forEach(select => {
                const selectedOption = select.options[select.selectedIndex];
                const priceField = select.closest(".product-row").querySelector('input[name^="price_"]');
                priceField.value = selectedOption.getAttribute("data-price");
            });

            // Function to add a new product row
            document.querySelector("#productFields").addEventListener("click", function (event) {
                if (event.target.classList.contains("add-product")) {
                    // Clone the first product row
                    const productRow = document.querySelector(".product-row").cloneNode(true);
                    const productCount = document.querySelectorAll('.product-row').length + 1; // Calculate the next product row number

                    // Update the name attributes of the new row to match the form fields
                    productRow.querySelector('select').name = `product_${productCount}`;
                    productRow.querySelector('input[type="number"]').name = `quantity_${productCount}`;
                    productRow.querySelector('input[readonly]').name = `price_${productCount}`;
                    productRow.querySelector('input[readonly]').id = `price_${productCount}`;

                    // Clear the quantity and price fields in the new row
                    productRow.querySelector('input[type="number"]').value = 1;
                    productRow.querySelector('input[readonly]').value = "";

                    // Change the button to remove the row (and add a minus sign)
                    const button = productRow.querySelector('button');
                    button.textContent = "-";
                    button.classList.remove("add-product");
                    button.classList.remove("btn-success");
                    button.classList.add("btn-danger");
                    button.classList.add("remove-product");

                    // Append the new row to the productFields div
                    document.getElementById("productFields").appendChild(productRow);

                    // Set the initial price for the new product row
                    const select = productRow.querySelector('select');
                    const selectedOption = select.options[select.selectedIndex];
                    const priceField = productRow.querySelector('input[readonly]');
                    priceField.value = selectedOption.getAttribute("data-price");
                }
            });

            // Function to remove a product row - FIXED VERSION
            document.getElementById("productFields").addEventListener("click", function (event) {
                if (event.target.classList.contains("remove-product") ||
                   (event.target.classList.contains("btn-danger") && event.target.textContent === "-")) {
                    console.log("Removing row", event.target);
                    event.target.closest(".product-row").remove();
                }
            });

            // update the price field when a product is selected
            document.querySelector("#productFields").addEventListener("change", function (event) {
                if (event.target.tagName === "SELECT") {
                    const selectedOption = event.target.options[event.target.selectedIndex];
                    const priceField = event.target.closest(".product-row").querySelector('input[name^="price_"]');
                    priceField.value = selectedOption.getAttribute("data-price");
                }
            });

            // Generate Total button handler
            document.getElementById("generateTotal").addEventListener("click", function() {
                let total = 0;

                // Loop through all product rows
                document.querySelectorAll('.product-row').forEach(row => {
                    const quantity = parseInt(row.querySelector('input[type="number"]').value) || 0;
                    const price = parseFloat(row.querySelector('input[readonly]').value) || 0;
                    total += quantity * price;
                });

                // Apply discount
                const discount = parseInt(document.getElementById("discount").value) || 0;
                total = total * (1 - discount/100);

                // Update total field
                document.getElementById("total").value = total.toFixed(2);
            });
        });
    </script>
{% endblock %}
